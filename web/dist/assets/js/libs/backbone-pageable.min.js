/*
  backbone-pageable
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/

(function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,n=Backbone.PageableCollection=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,n}}})(function(e,t){function n(t,n){if(t*=1,!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+n+"` must be a finite integer");return t}function r(e){for(var t,n,r,i,s={},o=decodeURIComponent,u=e.split("&"),a=0,f=u.length;f>a;a++){var l=u[a];t=l.split("="),n=t[0],r=t[1]||!0,n=o(n),i=s[n],d(i)?i.push(r):s[n]=i?[i,r]:r}return s}function i(){var t=arguments[0],n=e.toArray(arguments).slice(1),r=t.comparator;t.comparator=null;try{t.reset.apply(t,n)}finally{t.comparator=r,r&&t.sort()}return t}var s=e.extend,o=e.omit,u=e.clone,a=e.each,f=e.pick,l=e.contains,c=e.isEmpty,h=e.pairs,p=e.invert,d=e.isArray,v=e.isFunction,m=e.keys,g=e.isUndefined,y=Math.ceil,b=t.Collection.prototype,w=/[\s'"]/g,E=/[<>\s'"]/g,S=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(e,t){t=t||{};var n=this,r=n.mode=t.mode||n.mode||x.mode,i=s({},x.queryParams,n.queryParams,t.queryParams||{});i.directions=s({},x.queryParams.directions,n.queryParams.directions,i.directions||{}),n.queryParams=i;var o=n.state=s({},x.state,n.state,t.state||{});o.currentPage=null==o.currentPage?o.firstPage:o.currentPage,"server"==r||null!=o.totalRecords||c(e)||(o.totalRecords=e.length),n.switchMode(r,s({fetch:!1,resetState:!1,models:e},t));var a=t.comparator;if(o.sortKey&&!a&&n.setSorting(o.sortKey,o.order,t),"server"!=r){if(a&&t.full){delete n.comparator;var f=n.fullCollection;f.comparator=a,f.sort()}e&&!c(e)&&(n.getPage(o.currentPage),e.splice.apply(e,[0,e.length].concat(n.models)))}n._initState=u(n.state)},_makeFullCollection:function(e,n){var r,i,s,o=this,u=["url","model","sync","comparator"],a=o.constructor.prototype,f={};for(r=0,i=u.length;i>r;r++)s=u[r],g(a[s])||(f[s]=a[s]);var l=new(t.Collection.extend(f))(e,n);for(r=0,i=u.length;i>r;r++)s=u[r],o[s]!==a[s]&&(l[s]=s);return l},_makeCollectionEventHandler:function(t,n){return function(r,o,f,l){var c=t._handlers;a(m(c),function(e){var r=c[e];t.off(e,r),n.off(e,r)});var h=u(t.state),p=h.firstPage,d=0===p?h.currentPage:h.currentPage-1,v=h.pageSize,g=d*v,b=g+v;if("add"==r){var w,E,S,l=l||{};if(f==n)w=n.indexOf(o),w>=g&&b>w&&(S=t,E=w-g);else{w=g+t.indexOf(o),S=n;var E=l&&!e.isUndefined(l.at)?l.at+g:w}if(++h.totalRecords,t.state=t._checkState(h),S&&(S.add(o,s({},l||{},{at:E})),t.length>v)){var x=f._events.add,T={onAdd:!0};if(x.length){var N=x[x.length-1],C=N.callback;N.callback=function(){try{C.apply(this,arguments),t.pop(T)}finally{N.callback=C}}}else t.pop(T)}}if("remove"==r)if(l.onAdd)delete l.onAdd;else{if(--h.totalRecords){var k=h.totalPages=y(h.totalRecords/v);h.lastPage=0===p?k-1:k,h.currentPage>k&&(h.currentPage=h.lastPage)}else h.totalRecords=null,h.totalPages=null;t.state=t._checkState(h);var L,A=l.index;f==t?((L=n.at(b))&&t.push(L),n.remove(o)):A>=g&&b>A&&(t.remove(o),L=n.at(d*(v+A)),L&&t.push(L))}if("reset"==r||"sort"==r){if(l=f,f=o,f==t&&"reset"==r){var O=n.models.slice(0,g),M=n.models.slice(g+t.models.length);l=s(l,{silent:!0}),i(n,O.concat(t.models).concat(M),l)}("reset"==r||f==n)&&((h.totalRecords=n.models.length)||(h.totalRecords=null,h.totalPages=null,h.lastPage=h.currentPage=h.firstPage),t.state=t._checkState(h),f==t&&n.trigger(r,n,l),i(t,n.models.slice(g,b),l))}a(m(c),function(e){var r=c[e];a([t,n],function(t){t.on(e,r);var n=t._events[e];n.unshift(n.pop())})})}},_checkState:function(e){var t=this,r=t.mode,i=t.links,s=e.totalRecords,o=e.pageSize,u=e.currentPage,a=e.firstPage,f=e.totalPages;if(null!=s&&null!=o&&null!=u&&null!=a&&("infinite"==r?i:!0)){if(s=n(s,"totalRecords"),o=n(o,"pageSize"),u=n(u,"currentPage"),a=n(a,"firstPage"),1>o)throw new RangeError("`pageSize` must be >= 1");if(f=e.totalPages=y(s/o),0>a||a>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===a?f-1:f,"infinite"==r){if(!i[u+""])throw new RangeError("No link found for page "+u)}else{if(0===a&&(a>u||u>=f))throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based. Got "+u+".");if(1===a&&(a>u||u>f))throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based. Got "+u+".")}}return e},setPageSize:function(e,t){var r=this;return e=n(e,"pageSize"),t=t||{},r.state=r._checkState(s({},r.state,{pageSize:e,totalPages:y(r.state.totalRecords/e)})),r.getPage(r.state.currentPage,t)},switchMode:function(t,n){var r=this;if(!l(["server","client","infinite"],t))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');n=n||{fetch:!0,resetState:!0};var i=r.state=n.resetState?u(r._initState):r._checkState(s({},r.state));r.mode=t;var f,c=r.fullCollection,h=r._handlers=r._handlers||{};if("server"==t||c)"server"==t&&c&&(a(m(h),function(e){f=h[e],r.off(e,f),c.off(e,f)}),delete r._handlers,r._fullComparator=c.comparator,delete r.fullCollection);else{c=r._makeFullCollection(n.models||[]),c.pageableCollection=r,r.fullCollection=c;var p=r._makeCollectionEventHandler(r,c);a(["add","remove","reset","sort"],function(t){h[t]=f=e.bind(p,{},t),r.on(t,f),c.on(t,f)}),c.comparator=r._fullComparator}if("infinite"==t)for(var d=r.links={},v=i.firstPage,g=y(i.totalRecords/i.pageSize),b=0===v?g-1:g||v,w=i.firstPage;b>=w;w++)d[w]=r.url;else r.links&&delete r.links;return n.fetch?r.fetch(o(n,"fetch","resetState")):r},hasPrevious:function(){var e=this,t=e.state,n=t.currentPage;return"infinite"!=e.mode?n>t.firstPage:!!e.links[n-1]},hasNext:function(){var e=this,t=e.state,n=e.state.currentPage;return"infinite"!=e.mode?t.lastPage>n:!!e.links[n+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var r=this,u=r.mode,a=r.fullCollection;t=t||{fetch:!1};var f=r.state,l=f.firstPage,h=f.currentPage,p=f.lastPage,d=f.pageSize,v=e;switch(e){case"first":v=l;break;case"prev":v=h-1;break;case"next":v=h+1;break;case"last":v=p;break;default:v=n(e,"index")}r.state=r._checkState(s({},f,{currentPage:v}));var m=(0===l?v:v-1)*d,g=a&&a.length?a.models.slice(m,m+d):[];return"client"!=u&&("infinite"!=u||c(g))||t.fetch?("infinite"==u&&(t.url=r.links[v]),r.fetch(o(t,"fetch"))):i(r,g,o(t,"fetch"))},sync:function(e,n,r){var i=this;if("infinite"==i.mode){var o=r.success,u=i.state.currentPage;r.success=function(e,t,n){var a=i.links,f=i.parseLinks(e,s({xhr:n},r));f.first&&(a[i.state.firstPage]=f.first),f.prev&&(a[u-1]=f.prev),f.next&&(a[u+1]=f.next),o&&o(e,t,n)}}return(b.sync||t.sync).call(i,e,n,r)},parseLinks:function(t,n){var i=this,s=n.xhr.getResponseHeader("Link"),o=["first","prev","previous","next","last"],u={};a(s.split(","),function(e){var t=e.split(";"),n=t[0].replace(E,""),r=t.slice(1);a(r,function(e){var t=e.split("="),r=t[0].replace(w,""),i=t[1].replace(w,"");"rel"==r&&l(o,i)&&("previous"==i?u.prev=n:u[i]=n)})});var f,c,h=u.last||"";if(c=(f=h.indexOf("?"))?h.slice(f+1):""){var p=r(c),d=e.clone(i.state),v=i.queryParams,m=d.pageSize,g=1*p[v.totalRecords],y=1*p[v.currentPage],b=p[v.totalPages];g||(y?g=(0===d.firstPage?y+1:y)*m:b&&(g=b*m)),g&&(d.totalRecords=g),i.state=i._checkState(d)}return delete u.last,u},parse:function(t){var n=this;if(!d(t))return new TypeError("The server response must be an array");if(2===t.length&&e.isObject(t[0])&&d(t[1])){var r=n.queryParams,i=u(n.state),s=t[0];return a(h(o(r,"directions")),function(e){var t=e[0],n=e[1];i[t]=s[n]}),s.order&&(i.order=1*p(r.directions)[s.order]),n.state=n._checkState(i),t[1]}return t},fetch:function(t){var n=this;t=t||{};var a=n._checkState(n.state),l=n.mode;"infinite"!=l||t.url||(t.url=n.links[a.currentPage]);var c=t.data||{},p=t.url||e.result(n,"url")||"",d=p.indexOf("?");-1!=d&&(s(c,r(p.slice(d+1))),p=p.slice(0,d)),t.url=p,t.data=c;var y,w,E,S,T="client"==n.mode?f(n.queryParams,"sortKey","order"):o(f(n.queryParams,m(x.queryParams)),"directions"),N=h(T),C=u(n);for(y=0;N.length>y;y++)w=N[y],E=w[0],S=w[1],S=v(S)?S.call(C):S,null!=a[E]&&null!=S&&(c[S]=a[E]);a.sortKey&&a.order?c[T.order]=n.queryParams.directions[a.order+""]:a.sortKey||delete c[T.order];var k=h(o(n.queryParams,m(x.queryParams)));for(y=0;k.length>y;y++)w=k[y],S=w[1],S=v(S)?S.call(C):S,c[w[0]]=S;var L=n.fullCollection,A=n.links;if("server"!=l){var O=t.success;return t.success=function(e,n,r){r=r||{},g(t.silent)?delete r.silent:r.silent=t.silent;var o=e.models,u=a.currentPage;if("client"==l)i(L,o,r);else if(A[u]){var f=a.pageSize,c=(0===a.firstPage?u:u-1)*f,h=L.models,p=h.slice(0,c),d=h.slice(c+f);h=p.concat(o).concat(d),L.update(h,s({silent:!0,sort:!1},r)),L.comparator&&L.sort(),L.trigger("reset",L,r)}else L.add(o,s({at:L.length,silent:!0},r)),L.trigger("reset",L,r);O&&O(e,n,r)},b.fetch.call(n,s({},t,{silent:!0}))}return b.fetch.call(n,t)},_makeComparator:function(e,t){var n=this.state;return e=e||n.sortKey,t=t||n.order,e&&t?function(n,r){var i,s=n.get(e),o=r.get(e);return 1===t&&(i=s,s=o,o=i),s===o?0:o>s?-1:1}:void 0},setSorting:function(e,t,n){var r=this,i=r.state;i.sortKey=e,i.order=t=t||i.order;var o=r.fullCollection,u=!1,a=!1;e||(u=a=!0);var f=r.mode;n=s({side:"client"==f?f:"server",full:!0},n);var l=r._makeComparator(e,t),c=n.full,h=n.side;return"client"==h?c?(o&&(o.comparator=l),u=!0):(r.comparator=l,a=!0):"server"!=h||c||(r.comparator=l),u&&delete r.comparator,a&&o&&delete o.comparator,r}}),x=S.prototype;return S});