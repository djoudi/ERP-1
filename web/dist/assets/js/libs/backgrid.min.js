/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/

(function(e,t,n,r){function i(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function s(e,t,n){var r=t-(e+"").length;r=0>r?0:r;for(var i="",s=0;r>s;s++)i+=n;return i+e}function o(e,t){for(var r=0;t.length>r;r++){var i=t[r];if(n.isUndefined(e[i]))throw new TypeError("'"+i+"' is required")}}function u(e,t){if(n.isString(e)){var r=i(e)+t,s=f[r]||f.Extension[r];if(n.isUndefined(s))throw new ReferenceError("Class '"+r+"' not found");return s}return e}var a=e,f=e.Backgrid={VERSION:"0.1.2",Extension:{}},l="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||l.trim()){l="["+l+"]";var c=RegExp("^"+l+l+"*"),h=RegExp(l+l+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return(this+"").replace(c,"").replace(h,"")}}var p=f.CellFormatter=function(){};n.extend(p.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var d=f.NumberFormatter=function(e){if(e=e?n.clone(e):{},n.extend(this,this.defaults,e),0>this.decimals||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};d.prototype=new p,n.extend(d.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(isNaN(e)||null===e)return"";e=e.toFixed(~~this.decimals);var t=e.split("."),n=t[0],r=t[1]?(this.decimalSeparator||".")+t[1]:"";return n.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+r},toRaw:function(e){for(var t="",r=e.trim().split(this.orderSeparator),i=0;r.length>i;i++)t+=r[i];var s=t.split(this.decimalSeparator);t="";for(var i=0;s.length>i;i++)t=t+s[i]+".";"."===t[t.length-1]&&(t=t.slice(0,t.length-1));var o=1*(1*t).toFixed(~~this.decimals);return n.isNumber(o)&&!n.isNaN(o)?o:void 0}});var v=f.DatetimeFormatter=function(e){if(e=e?n.clone(e):{},n.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true")};v.prototype=new p,n.extend(v.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,t){if(n.isNull(e)||n.isUndefined(e))return e;e=e.trim();var r=e.split(this.ISO_SPLITTER_RE)||[],i=this.DATE_RE.test(r[0])?r[0]:"",o=i&&r[1]?r[1]:this.TIME_RE.test(r[0])?r[0]:"",u=this.DATE_RE.exec(i)||[],a=this.TIME_RE.exec(o)||[];if(t){if(this.includeDate&&n.isUndefined(u[0]))return;if(this.includeTime&&n.isUndefined(a[0]))return;if(!this.includeDate&&i)return;if(!this.includeTime&&o)return}var f=new Date(Date.UTC(1*u[1]||0,1*u[2]-1||0,1*u[3]||0,1*a[1]||null,1*a[2]||null,1*a[3]||null,1*a[5]||null)),l="";return this.includeDate&&(l=s(f.getUTCFullYear(),4,0)+"-"+s(f.getUTCMonth()+1,2,0)+"-"+s(f.getUTCDate(),2,0)),this.includeTime&&(l=l+(this.includeDate?"T":"")+s(f.getUTCHours(),2,0)+":"+s(f.getUTCMinutes(),2,0)+":"+s(f.getUTCSeconds(),2,0),this.includeMilli&&(l=l+"."+s(f.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(l+="Z"),l},fromRaw:function(e){return this._convert(e)},toRaw:function(e){return this._convert(e,!0)}});var m=f.CellEditor=r.View.extend({initialize:function(e){o(e,["formatter","column","model"]),this.parent=e.parent,this.formatter=e.formatter,this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.parent&&n.isFunction(this.parent.on)&&this.listenTo(this.parent,"editing",this.postRender)},postRender:function(){return this.$el.focus(),this}}),g=f.InputCellEditor=m.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){m.prototype.initialize.apply(this,arguments),e.placeholder&&this.$el.attr("placeholder",e.placeholder),this.listenTo(this,"done",this.remove)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(e){if("keydown"===e.type)if(13===e.keyCode||9===e.keyCode){e.preventDefault();var t=this.formatter.toRaw(this.$el.val());n.isUndefined(t)||!this.model.set(this.column.get("name"),t,{validate:!0})?this.trigger("error"):this.trigger("done")}else 27===e.keyCode&&(e.stopPropagation(),this.trigger("done"));else if("blur"===e.type)if(this.formatter.fromRaw(this.model.get(this.column.get("name")))===this.$el.val())this.trigger("done");else var r=this,i=a.setTimeout(function(){r.$el.focus(),a.clearTimeout(i)},1)},postRender:function(){if("right"===this.$el.css("text-align")){var e=this.$el.val();this.$el.focus().val(null).val(e)}else this.$el.focus();return this}}),y=f.Cell=r.View.extend({tagName:"td",formatter:new p,editor:g,events:{click:"enterEditMode"},initialize:function(e){o(e,["model","column"]),this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.formatter=u(this.formatter,"Formatter"),this.editor=u(this.editor,"CellEditor"),this.listenTo(this.model,"change:"+this.column.get("name"),function(){this.$el.hasClass("editor")||this.render()})},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){this.column.get("editable")&&(this.currentEditor=new this.editor({parent:this,column:this.column,model:this.model,formatter:this.formatter}),this.trigger("edit",this,this.currentEditor),this.listenTo(this.currentEditor,"done",this.exitEditMode),this.listenTo(this.currentEditor,"error",this.renderError),this.$el.empty(),this.undelegateEvents(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),this.trigger("editing",this,this.currentEditor))},renderError:function(){this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.off(null,null,this),this.currentEditor.remove(),delete this.currentEditor,this.$el.removeClass("editor"),this.render(),this.delegateEvents()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this,arguments),delete this.currentEditor),r.View.prototype.remove.apply(this,arguments)}});f.StringCell=y.extend({className:"string-cell"}),f.UriCell=y.extend({className:"uri-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){var t=encodeURI(e);return"undefined"===t?void 0:t}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{href:e,title:e,target:"_blank"}).text(e)),this}}),f.EmailCell=y.extend({className:"email-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){var t=e.split("@");return 2===t.length&&n.all(t)?e:void 0}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{href:"mailto:"+e,title:e}).text(e)),this}});var b=f.NumberCell=y.extend({className:"number-cell",decimals:d.prototype.defaults.decimals,decimalSeparator:d.prototype.defaults.decimalSeparator,orderSeparator:d.prototype.defaults.orderSeparator,formatter:d,initialize:function(){y.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});f.IntegerCell=b.extend({className:"integer-cell",decimals:0});var w=f.DatetimeCell=y.extend({className:"datetime-cell",includeDate:v.prototype.defaults.includeDate,includeTime:v.prototype.defaults.includeTime,includeMilli:v.prototype.defaults.includeMilli,formatter:v,initialize:function(){y.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli});var e=this.includeDate?"YYYY-MM-DD":"";e+=this.includeDate&&this.includeTime?"T":"",e+=this.includeTime?"HH:mm:ss":"",e+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:n.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:e})})}});f.DateCell=w.extend({className:"date-cell",includeTime:!1}),f.TimeCell=w.extend({className:"time-cell",includeDate:!1}),f.BooleanCell=y.extend({className:"boolean-cell",editor:n.template("<input type='checkbox'<%= checked ? checked='checked' : '' %> />'"),events:{click:"enterEditMode","blur input[type=checkbox]":"exitEditMode","change input[type=checkbox]":"save"},render:function(){return this.$el.empty(),this.currentEditor=t(this.editor({checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.$el.append(this.currentEditor),this},enterEditMode:function(){this.$el.addClass("editor"),this.currentEditor.focus()},exitEditMode:function(){this.$el.removeClass("editor")},save:function(){var e=this.formatter.toRaw(this.currentEditor.prop("checked"));this.model.set(this.column.get("name"),e)}});var E=f.SelectCellEditor=m.extend({tagName:"select",events:{change:"save",blur:"save"},template:n.template('<option value="<%= value %>" <%= selected ? \'selected="selected"\' : "" %>><%= text %></option>'),setOptionValues:function(e){this.optionValues=e},_renderOptions:function(e,t){for(var n="",r=0;e.length>r;r++)n+=this.template({text:e[r][0],value:e[r][1],selected:t==e[r][1]});return n},render:function(){this.$el.empty();var e=n.result(this,"optionValues"),r=this.model.get(this.column.get("name"));if(!n.isArray(e))throw TypeError("optionValues must be an array");for(var i=null,s=null,i=null,o=null,u=null,a=0;e.length>a;a++){var i=e[a];if(n.isArray(i))s=i[0],i=i[1],this.$el.append(this.template({text:s,value:i,selected:i==r}));else{if(!n.isObject(i))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");o=i.name,u=t("<optgroup></optgroup>",{label:o}),u.append(this._renderOptions(i.values,r)),this.$el.append(u)}}return this},save:function(){this.model.set(this.column.get("name"),this.formatter.toRaw(this.$el.val())),this.trigger("done")}});f.SelectCell=y.extend({className:"select-cell",editor:E,optionValues:void 0,initialize:function(){y.prototype.initialize.apply(this,arguments),o(this,["optionValues"]),this.optionValues=n.result(this,"optionValues"),this.listenTo(this,"edit",this.setOptionValues)},setOptionValues:function(e,t){t.setOptionValues(this.optionValues)},render:function(){this.$el.empty();var e=this.optionValues,t=this.formatter.fromRaw(this.model.get(this.column.get("name")));try{if(!n.isArray(e)||n.isEmpty(e))throw new TypeError;for(var r=0;e.length>r;r++){var i=e[r];if(n.isArray(i)){var s=i[0],i=i[1];if(i==t){this.$el.append(s);break}}else{if(!n.isObject(i))throw new TypeError;for(var o=i.values,u=0;o.length>u;u++){var a=o[u];if(a[1]==t){this.$el.append(a[0]);break}}}}}catch(f){throw f instanceof TypeError?TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}"):f}return this}});var S=f.Column=r.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,cell:void 0,headerCell:void 0},initialize:function(e){o(e,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var t=u(this.get("cell"),"Cell");this.set({cell:t},{silent:!0})}}),x=f.Columns=r.Collection.extend({model:S}),T=f.Row=r.View.extend({tagName:"tr",initialize:function(e){o(e,["columns","model"]);var t=this.columns=e.columns;t instanceof r.Collection||(t=this.columns=new x(t)),this.listenTo(t,"change:renderable",this.renderColumn);for(var i=this.cells=[],s=0;t.length>s;s++){var u=t.at(s);i.push(new(u.get("cell"))({column:u,model:this.model}))}this.listenTo(t,"add",function(e,t,r){r=n.defaults(r||{},{render:!0});var s=t.indexOf(e),o=new(e.get("cell"))({column:e,model:this.model});i.splice(s,0,o),this.renderColumn(e,e.get("renderable")&&r.render)}),this.listenTo(t,"remove",function(e){this.renderColumn(e,!1)})},renderColumn:function(e,t){for(var n=this.cells,r=this.columns,i=-1,s=0;n.length>s;s++){var o=n[s];if(o.column.get("name")==e.get("name")){i=s;break}}if(-1!=i){var u=this.$el;if(t){var o=n[i];0===i?u.prepend(o.render().$el):i===r.length-1?u.append(o.render().$el):u.children().eq(i).before(o.render().$el)}else u.children().eq(i).detach()}},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;this.cells.length>t;t++){var n=this.cells[t];n.column.get("renderable")&&e.appendChild(n.render().el)}return this.el.appendChild(e),this},remove:function(){for(var e=0;this.cells.length>e;e++){var t=this.cells[e];t.remove.apply(t,arguments)}return r.View.prototype.remove.apply(this,arguments)}}),N=f.HeaderCell=r.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(e){o(e,["column","collection"]),this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.listenTo(r,"backgrid:sort",this._resetCellDirection)},direction:function(e){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),e&&this.$el.addClass(e),this._direction=e),this._direction},_resetCellDirection:function(e,t,n,r){r==this.collection&&(e!==this.column.get("name")?this.direction(null):this.direction(t))},onClick:function(e){e.preventDefault();var t=this.column.get("name");this.column.get("sortable")&&("ascending"===this.direction()?this.sort(t,"descending",function(e,n){var r=e.get(t),i=n.get(t);return r===i?0:r>i?-1:1}):"descending"===this.direction()?this.sort(t,null):this.sort(t,"ascending",function(e,n){var r=e.get(t),i=n.get(t);return r===i?0:i>r?-1:1}))},sort:function(e,t,n){n=n||this._cidComparator;var i=this.collection;if(r.PageableCollection&&i instanceof r.PageableCollection){var s;s="ascending"===t?-1:"descending"===t?1:null,i.setSorting(s?e:null,s),"client"==i.mode?(i.fullCollection.comparator||(i.fullCollection.comparator=n),i.fullCollection.sort()):i.fetch()}else i.comparator=n,i.sort();r.trigger("backgrid:sort",e,t,n,this.collection)},_cidComparator:function(e,t){var r=e.cid,i=t.cid;if(!n.isUndefined(r)&&!n.isUndefined(i)){if(r=1*r.slice(1),i=1*i.slice(1),i>r)return-1;if(r>i)return 1}return 0},render:function(){this.$el.empty();var e=t("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}});f.HeaderRow=f.Row.extend({initialize:function(e){o(e,["columns","collection"]);var t=this.columns=e.columns;t instanceof r.Collection||(t=this.columns=new x(t)),this.listenTo(t,"change:renderable",this.renderColumn);for(var i=this.cells=[],s=0;t.length>s;s++){var u=t.at(s),a=u.get("headerCell")||e.headerCell||N;i.push(new a({column:u,collection:this.collection}))}this.listenTo(t,"add",function(t,r,s){s=n.defaults(s||{},{render:!0});var o=r.indexOf(t),u=t.get("headerCell")||e.headerCell||N;u=new u({column:t,collection:this.collection}),i.splice(o,0,u),this.renderColumn(t,t.get("renderable")&&s.render)}),this.listenTo(t,"remove",function(e){this.renderColumn(e,!1)})}});var C=f.Header=r.View.extend({tagName:"thead",initialize:function(e){o(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof r.Collection||(this.columns=new x(this.columns)),this.row=new f.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this},remove:function(){return this.row.remove.apply(this.row,arguments),r.View.prototype.remove.apply(this,arguments)}}),k=f.Body=r.View.extend({tagName:"tbody",initialize:function(e){o(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof r.Collection||(this.columns=new x(this.columns)),this.row=e.row||T,this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this);var t=this.collection;this.listenTo(t,"add",this.insertRow),this.listenTo(t,"remove",this.removeRow),this.listenTo(t,"sort",this.refresh),this.listenTo(t,"reset",this.refresh)},insertRow:function(e,t,i){if(!(t instanceof r.Collection||i))return this.collection.add(e,i=t),void 0;i=n.extend({render:!0},i||{});var s=new this.row({columns:this.columns,model:e}),o=t.indexOf(e);this.rows.splice(o,0,s);var u=this.$el,a=u.children(),f=s.render().$el;i.render&&(o>=a.length?u.append(f):a.eq(o).before(f))},removeRow:function(e,t,r){return r?((n.isUndefined(r.render)||r.render)&&this.rows[r.index].remove(),this.rows.splice(r.index,1),void 0):(this.collection.remove(e,r=t),void 0)},refresh:function(){var e=this;return n.each(e.rows,function(e){e.remove()}),e.rows=e.collection.map(function(t){var n=new e.row({columns:e.columns,model:t});return n}),e.render(),r.trigger("backgrid:refresh"),e},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;this.rows.length>t;t++){var n=this.rows[t];e.appendChild(n.render().el)}return this.el.appendChild(e),this},remove:function(){for(var e=0;this.rows.length>e;e++){var t=this.rows[e];t.remove.apply(t,arguments)}return r.View.prototype.remove.apply(this,arguments)}});f.Footer=r.View.extend({tagName:"tfoot",initialize:function(e){o(e,["columns","collection"]),this.parent=e.parent,this.columns=e.columns,this.columns instanceof r.Collection||(this.columns=new f.Columns(this.columns))}}),f.Grid=r.View.extend({tagName:"table",className:"backgrid",header:C,body:k,footer:null,initialize:function(e){o(e,["columns","collection"]),e.columns instanceof r.Collection||(e.columns=new x(e.columns)),this.columns=e.columns,this.header=e.header||this.header,this.header=new this.header(e),this.body=e.body||this.body,this.body=new this.body(e),this.footer=e.footer||this.footer,this.footer&&(this.footer=new this.footer(e)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(e),this.body=new(this.body.remove().constructor)(e),this.footer&&(this.footer=new(this.footer.remove().constructor)(e)),this.render()})},insertRow:function(e,t,n){return this.body.insertRow(e,t,n)},removeRow:function(e,t,n){return this.body.removeRow(e,t,n)},insertColumn:function(e,t){var n=this;return t=t||{render:!0},n.columns.add(e,t),n},removeColumn:function(e,t){var n=this;return n.columns.remove(e,t),n},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),r.View.prototype.remove.apply(this,arguments)}})})(this,$,_,Backbone);